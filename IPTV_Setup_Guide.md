# IPTV 自动更新系统搭建指南

本文档记录了基于 Docker 搭建 `Guovin/iptv-api` 直播源自动更新系统的全过程，包括问题排查与最终解决方案。

## 1. 项目目标

*   **核心功能**：自动抓取、测速、生成高质量的 IPTV 直播源（支持 IPv6）。
*   **部署环境**：iStoreOS (OpenWrt) + Docker。
*   **客户端**：Apple TV (APTV) 或其他支持 m3u 订阅的播放器。

## 2. 最终解决方案 (Docker Compose)

这是经过多次调试后的**最佳配置**。它解决了 IPv6 测速问题和 Web 访问不稳定的问题。

### `docker-compose.yml`

```yaml
version: '3'

services:
  # 核心服务：负责抓取和测速
  iptv-api:
    image: guovern/iptv-api:${IMAGE_VERSION:-latest}
    container_name: iptv-api
    restart: unless-stopped
    # 关键配置：使用 Host 模式，让容器直接使用宿主机的 IPv6 网络
    # 这样才能抓取到高质量的运营商内网 IPv6 源
    network_mode: host
    volumes:
      - ./config:/iptv-api/config  # 配置文件目录
      - ./output:/iptv-api/output  # 结果输出目录
    environment:
      - TZ=Asia/Shanghai

  # Web 服务：负责提供稳定的下载链接
  web-server:
    image: nginx:alpine
    container_name: iptv-web
    restart: always
    ports:
      - "18989:80"  # 访问端口，可自定义
    volumes:
      # 将 iptv-api 生成的结果挂载给 Nginx 读取
      - ./output:/usr/share/nginx/html:ro
```

## 3. 使用说明

### 3.1 部署
1.  将上述内容保存为 `docker-compose.yml`。
2.  在同级目录下创建 `config` 和 `output` 文件夹。
3.  运行命令：`docker-compose up -d`（或在面板中点击部署）。

### 3.2 客户端配置 (APTV)
*   **订阅地址**：`http://<你的iStoreOS_IP>:18989/result.m3u`
*   **配置建议**：开启“自动刷新配置”，让客户端每天自动同步最新源。

## 4. 排查与优化过程复盘

### 问题一：Web 访问报错 (502 Bad Gateway)
*   **现象**：直接访问 `iptv-api` 容器端口报错。
*   **原因**：容器内置 Web 服务不稳定或未启动。
*   **解决**：引入独立的 `nginx` 容器 (`web-server`)，专门负责静态文件服务，稳定可靠。

### 问题二：直播卡顿，源质量差
*   **现象**：生成的源虽然能看，但延迟高、卡顿。
*   **原因**：Docker 默认 Bridge 网络模式不支持 IPv6。导致测速时丢弃了所有高质量的 IPv6 源，只保留了拥挤的 IPv4 源。
*   **解决**：将 `iptv-api` 的网络模式改为 `network_mode: host`。

### 问题三：IPv6 连通性验证
*   **误区**：尝试 `ping6 ipv6.google.com` 失败，误以为 IPv6 不通。
*   **真相**：Google IPv6 在国内不可达。
*   **验证**：使用 `ping6 2400:3200::1` (阿里 DNS) 测试，延迟仅 7ms，证明国内 IPv6 直连环境完美。

## 5. 进阶优化建议

1.  **配置文件优化**：
    *   修改 `config/config.ini`。
    *   设置 `min_resolution = 1920x1080` (只保留高清)。
    *   设置 `min_speed = 1.0` (提高测速门槛，宁缺毋滥)。
    *   设置 `sort_by_speed = true` (速度快的排前面)。

2.  **自动更新**：
    *   建议配合 `Watchtower` 使用，自动更新 `iptv-api` 镜像，获取最新功能。

---
*Generated by Antigravity*
